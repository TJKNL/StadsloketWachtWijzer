<!DOCTYPE html>
<html lang="{{ lang|default('nl') }}">
    <head>
        <!-- Google Tag Manager -->
        <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() {dataLayer.push(arguments);}
        
        // Default consent settings - all denied until user gives consent
        gtag('consent', 'default', {
            'ad_storage': 'denied',
            'analytics_storage': 'denied',
            'wait_for_update': 500
        });
        </script>
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-4XECBEDSBR"></script>
        <script>
          gtag('js', new Date());
          gtag('config', 'G-4XECBEDSBR');
          // AdSense configuration
          gtag('config', 'ca-pub-4863672404977337');
        </script>
        
        <!-- Google AdSense -->
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4863672404977337" crossorigin="anonymous"></script>

        <!-- AdSense initialization -->
        <script>
        window.addEventListener('load', function() {
            // AdSense auto-initialization is preferred over manual initialization
            console.log('Page loaded - AdSense ready');
        });
        </script>
        
        <!-- Primary Meta Tags -->
        <meta charset="UTF-8">
        {% if lang == 'nl' %}
        <title>WachtWijzer Stadsloketten Amsterdam | Live Actuele Wachttijden</title>
        <meta name="description" content="Bekijk direct de actuele wachttijden bij alle stadsloketten in Amsterdam. Vind het loket met de kortste wachttijd en bespaar tijd.">
        {% elif lang == 'en' %}
        <title>Amsterdam City Offices Wait Times | Live Updates</title>
        <meta name="description" content="Check real-time wait times at Amsterdam City Offices. Find the shortest queue instantly.">
        {% elif lang == 'tr' %}
        <title>Amsterdam Şehir Ofisleri Bekleme Süreleri | Canlı Güncellemeler</title>
        <meta name="description" content="Amsterdam Şehir Ofislerindeki bekleme sürelerini kontrol edin. En kısa kuyruğu hemen bulun.">
        {% elif lang == 'ma' %}
        <title>أوقات الانتظار في مكاتب مدينة أمستردام | معلومات مباشرة</title>
        <meta name="description" content="تحقق من أوقات الانتظار في مكاتب مدينة أمستردام. اعثر على أقصر طابور على الفور.">
        {% endif %}
        
        <meta name="keywords" content="wachttijden stadsloketten Amsterdam, Amsterdam stadsloket wachtrij, gemeente Amsterdam wachttijd, actuele wachtrijen stadsloketten, wachttijden gemeente Amsterdam">
        <meta name="author" content="Twan Kerkhof">
        
        <!-- Canonical URL and Language alternates -->
        <link rel="canonical" href="{{ request.url_root }}" />
        <link rel="alternate" hreflang="nl" href="{{ request.url_root }}?lang=nl" />
        <link rel="alternate" hreflang="en" href="{{ request.url_root }}?lang=en" />
        <link rel="alternate" hreflang="tr" href="{{ request.url_root }}?lang=tr" />
        <link rel="alternate" hreflang="ma" href="{{ request.url_root }}?lang=ma" />
        <link rel="alternate" hreflang="x-default" href="{{ request.url_root }}" />
        
        <!-- Viewport and Favicon -->
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="icon" href="{{ url_for('static', filename='images/favicon.ico') }}" type="image/x-icon">
        <link rel="shortcut icon" href="{{ url_for('static', filename='images/favicon.ico') }}" type="image/x-icon">
        <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='images/apple-touch-icon.png') }}">
        <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='images/favicon-32x32.png') }}">
        <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='images/favicon-16x16.png') }}">
        <link rel="manifest" href="{{ url_for('static', filename='site.webmanifest') }}">
        <meta name="theme-color" content="#E32E35">
        
        <!-- Open Graph / Facebook -->
        <meta property="og:type" content="website">
        <meta property="og:url" content="{{ request.url }}">
        <meta property="og:title" content="Wachttijden Stadsloketten Amsterdam | Actuele Informatie">
        <meta property="og:description" content="Bekijk actuele wachttijden bij alle stadsloketten in Amsterdam. Vind het loket met de kortste wachttijd en plan uw bezoek efficiënt.">
        <meta property="og:image" content="{{ url_for('static', filename='images/hero_design_remove_bg_cropped.png', _external=True) }}">
        
        <!-- Twitter -->
        <meta property="twitter:card" content="summary_large_image">
        <meta property="twitter:url" content="{{ request.url }}">
        <meta property="twitter:title" content="Wachttijden Stadsloketten Amsterdam | Actuele Informatie">
        <meta property="twitter:description" content="Bekijk actuele wachttijden bij alle stadsloketten in Amsterdam. Vind het loket met de kortste wachttijd en plan uw bezoek efficiënt.">
        <meta property="twitter:image" content="{{ url_for('static', filename='images/hero_design_remove_bg_cropped.png', _external=True) }}">
        
        <!-- Structured Data -->
        <script type="application/ld+json">
        {
          "@context": "https://schema.org",
          "@type": "WebApplication",
          "name": "Wachttijden Stadsloketten Amsterdam",
          "description": "Bekijk actuele wachttijden bij alle stadsloketten in Amsterdam",
          "url": "{{ request.url_root }}",
          "applicationCategory": "UtilityApplication",
          "operatingSystem": "All",
          "keywords": "wachttijden, stadsloketten, Amsterdam, wachtrij, gemeente",
          "offers": {
            "@type": "Offer",
            "price": "0"
          },
          "provider": {
            "@type": "Person",
            "name": "Twan Kerkhof"
          },
          "audience": {
            "@type": "Audience",
            "audienceType": "Inwoners Amsterdam"
          }
        }
        </script>
        
        <!-- Resource preconnection -->
        <link rel="preconnect" href="https://cdnjs.cloudflare.com">
        <link rel="preconnect" href="https://cdn.jsdelivr.net">
        
        <!-- Stylesheets -->
        <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
        
        <!-- External libraries -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js" defer></script>
        
        <!-- Cache control -->
        <meta http-equiv="Cache-Control" content="max-age=1800">

        <!-- TCF API Integration -->
        <script>
        // TCF API handling function (simplified version)
        function setupTCF() {
            window.__tcfapi = function(command, version, callback) {
                if (command === 'addEventListener') {
                    const tcData = {
                        gdprApplies: true,
                        eventStatus: 'tcloaded',
                        purpose: {consents: {}}
                    };
                    callback(tcData, true);
                } else if (command === 'getTCData') {
                    const tcData = {
                        gdprApplies: true,
                        eventStatus: 'tcloaded',
                        purpose: {consents: {}}
                    };
                    callback(tcData, true);
                }
            };
        }
        setupTCF();
        </script>

        <!-- Leaflet map for travel time calculations -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
          crossorigin=""></script>
    </head>
<body>
    <!-- Language switcher -->
    <div class="language-switcher">
        {% for code, label, flag in supported_languages %}
            <a href="?lang={{ code }}">
                {{ flag }}
            </a>
        {% endfor %}
    </div>

    <!-- Cookie consent banner -->
    <div id="cookie-consent" class="cookie-bento">
        <h3><i class="fas fa-cookie-bite"></i> {{ translations[lang]['cookie_banner_title'] }}</h3>
        <p>{{ translations[lang]['cookie_banner_text'] }}</p>
        
        <div id="consent-initial-buttons" class="cookie-buttons">
            <button id="cookie-accept-all" class="cookie-btn accept">{{ translations[lang]['cookie_accept_button'] }}</button>
            <button id="show-more-options" class="cookie-btn options">{{ translations[lang]['cookie_more_options'] }}</button>
        </div>
        
        <div id="consent-advanced" class="consent-advanced" style="display: none;">
            <div class="consent-choices">
                <div class="consent-option">
                    <input type="checkbox" id="consent-analytics" name="consent-analytics" checked>
                    <label for="consent-analytics">{{ translations[lang]['cookie_analytics_option'] }}</label>
                    <div class="option-description">{{ translations[lang]['cookie_analytics_description'] }}</div>
                </div>
                <div class="consent-option">
                    <input type="checkbox" id="consent-ads" name="consent-ads" checked>
                    <label for="consent-ads">{{ translations[lang]['cookie_ads_option'] }}</label>
                    <div class="option-description">{{ translations[lang]['cookie_ads_description'] }}</div>
                </div>
            </div>
            
            <div class="cookie-buttons">
                <button id="cookie-customize" class="cookie-btn customize">{{ translations[lang]['cookie_save_choices'] }}</button>
                <button id="cookie-reject-all" class="cookie-btn decline">{{ translations[lang]['cookie_decline_all'] }}</button>
            </div>
        </div>
        
        <a href="{{ url_for('privacy') }}" class="cookie-policy-link">{{ translations[lang]['cookie_more_info'] }}</a>
    </div>

    <!-- Hero section -->
    <header class="hero">
        <div class="hero-content">
            <h1>{{ translations[lang]['hero_title'] }}</h1>
            <p>{{ translations[lang]['hero_subtitle'] }}</p>
        </div>
        <div class="hero-image">
            <img src="{{ url_for('static', filename='images/hero_design_remove_bg_cropped.png') }}" alt="Amsterdam stadsloketten wachttijden">
        </div>
    </header>
    
    <!-- Streamlined recommendation and wait times - NEW STRUCTURE -->
    <div class="main-content">
        <!-- Data update status - More subtle placement -->
        <div class="data-status">
            {% if last_update %}
            <p><i class="fas fa-sync-alt"></i> {{ translations[lang]['data_updated'] }}: {{ last_update.strftime('%H:%M') }}</p>
            {% endif %}
        </div>
        
        <!-- Primary action for location -->
        <div class="quick-action-bar">
            <button id="share-location" class="location-btn">
                <i class="fas fa-bicycle"></i> 
                {{ translations[lang]['calculate_travel'] }}
            </button>
            <p id="location-status" class="location-status" style="display: none;"></p>
            
            <!-- Collapsible chart toggle -->
            <button id="show-patterns" class="action-btn">
                <i class="fas fa-chart-line"></i>
                {{ translations[lang]['show_patterns'] }}
            </button>
        </div>
        
        <!-- Primary recommendation card - Clearly highlighted -->
        <div class="recommendation-container">
            {% if best_loket %}
            <div class="best-loket-card">
                <div class="recommendation-header">
                    <h2><i class="fas fa-star"></i> {{ translations[lang]['card_recommended_location'] }}</h2>
                    <span class="badge">{{ translations[lang]['shortest_wait'] }}</span>
                </div>
                <div class="recommendation-body">
                    <h3>{{ best_loket[1] }}</h3>
                    <div class="stats-container">
                        <div class="stat-item primary">
                            <i class="fas fa-clock"></i>
                            <span class="value">{{ best_loket[2] }}</span>
                            <span class="label">{{ translations[lang]['minutes'] }}</span>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-users"></i>
                            <span class="value">{{ best_loket[3] }}</span>
                            <span class="label">{{ translations[lang]['waiting'] }}</span>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Will be populated with combined recommendation when location is shared -->
            <div id="combined-recommendation" style="display: none;"></div>
        </div>
        
        <!-- Map container - Hidden until location shared -->
        <div id="map-container" class="map-container" style="display: none;">
            <div id="map" style="height: 300px; width: 100%; border-radius: 8px;"></div>
        </div>
        
        <!-- Collapsible chart section - Initially hidden for simplicity -->
        <div id="chart-section" class="chart-section" style="display: none;">
            <h2>{{ translations[lang]['plot_title'] }}</h2>
            
            <div class="day-selector">
                <button class="day-button" data-day="1">{{ translations[lang]['day_monday'] }}</button>
                <button class="day-button" data-day="2">{{ translations[lang]['day_tuesday'] }}</button>
                <button class="day-button" data-day="3">{{ translations[lang]['day_wednesday'] }}</button>
                <button class="day-button" data-day="4">{{ translations[lang]['day_thursday'] }}</button>
                <button class="day-button" data-day="5">{{ translations[lang]['day_friday'] }}</button>
            </div>
            
            <div class="opening-hours-note" id="opening-hours-note"></div>
            
            <div class="chart-responsive-wrapper">
                <canvas id="seasonalityChart"></canvas>
            </div>
        </div>
        
        <!-- All locations grid - Simplified cards -->
        <div class="locations-header">
            <h2>{{ translations[lang]['all_locations'] }}</h2>
            <div class="list-controls">
                <button id="sort-by-wait" class="sort-btn active">
                    <i class="fas fa-clock"></i> {{ translations[lang]['sort_by_wait'] }}
                </button>
                <button id="sort-by-total" class="sort-btn" style="display: none;">
                    <i class="fas fa-hourglass-half"></i> {{ translations[lang]['sort_by_total'] }}
                </button>
            </div>
        </div>
        
        <div class="location-grid" id="all-locations-container">
            {% for loket in loket_data %}
            <div class="location-card" data-id="{{ loket[0] }}" data-wait="{{ loket[2] }}">
                <h3>{{ loket[1] }}</h3>
                <div class="card-content">
                    <div class="wait-info">
                        <div class="wait-time">
                            <span class="value">{{ loket[2] }}</span>
                            <span class="unit">{{ translations[lang]['minutes'] }}</span>
                        </div>
                        <div class="people-waiting">
                            <i class="fas fa-users"></i> {{ loket[3] }}
                        </div>
                    </div>
                    
                    <!-- Travel info (hidden until location shared) -->
                    <div class="travel-info" style="display: none;">
                        <div class="travel-time">
                            <i class="fas fa-bicycle"></i> <span class="travel-time-value"></span>
                        </div>
                        <div class="distance">
                            <i class="fas fa-road"></i> <span class="distance-value"></span>
                        </div>
                        <div class="total-time">
                            <i class="fas fa-hourglass-half"></i> <span class="total-time-value"></span>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Minimal, collapsible FAQ section -->
        <div class="faq-toggle">
            <button id="toggle-faq" class="toggle-btn">
                <i class="fas fa-question-circle"></i> {{ translations[lang]['show_faq'] }}
            </button>
        </div>
        
        <div id="faq-section" class="faq-section" style="display: none;">
            <h2>{{ translations[lang]['faq_title'] }}</h2>
            
            <div class="faq-accordion">
                <div class="faq-item">
                    <div class="faq-question">
                        <h3>{{ translations[lang]['faq_q1_title'] }}</h3>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="faq-answer">
                        <p>{{ translations[lang]['faq_q1_text'] }}</p>
                    </div>
                </div>
                
                <!-- Repeat for other FAQ items -->
                <div class="faq-item">
                    <div class="faq-question">
                        <h3><i class="fas fa-map-marker-alt"></i> {{ translations[lang]['faq_q2_title'] }}</h3>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="faq-answer">
                        <p>{{ translations[lang]['faq_q2_text'] }}</p>
                    </div>
                </div>
                
                <div class="faq-item">
                    <div class="faq-question">
                        <h3><i class="fas fa-clock"></i> {{ translations[lang]['faq_q3_title'] }}</h3>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="faq-answer">
                        <p>{{ translations[lang]['faq_q3_text'] }}</p>
                    </div>
                </div>
                
                <div class="faq-item">
                    <div class="faq-question">
                        <h3><i class="fas fa-calendar-check"></i> {{ translations[lang]['faq_q4_title'] }}</h3>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="faq-answer">
                        <p>{{ translations[lang]['faq_q4_text'] }}</p>
                    </div>
                </div>
                
                <div class="faq-item">
                    <div class="faq-question">
                        <h3><i class="fas fa-door-open"></i> {{ translations[lang]['faq_q5_title'] }}</h3>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="faq-answer">
                        <p>{{ translations[lang]['faq_q5_text'] }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Discreet ad placement -->
    <div class="ad-container">
        <div class="ad-label">{{ translations[lang]['advertisement'] }}</div>
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4863672404977337" crossorigin="anonymous"></script>
        <!-- Horizontal -->
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-4863672404977337"
             data-ad-slot="4370543747"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
        <script>
             (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
    </div>
    
    <!-- App JavaScript - Streamlined functionality -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize core functionality
            setupChartToggle();
            setupFaqAccordion();
            setupSorting();
            initCharts();
            initLocationSharing();
            
            // Run AdSense
            (adsbygoogle = window.adsbygoogle || []).push({});
        });
        
        // Toggle chart visibility
        function setupChartToggle() {
            const showPatternsBtn = document.getElementById('show-patterns');
            const chartSection = document.getElementById('chart-section');
            
            showPatternsBtn.addEventListener('click', function() {
                if (chartSection.style.display === 'none') {
                    chartSection.style.display = 'block';
                    showPatternsBtn.innerHTML = `<i class="fas fa-chart-line"></i> {{ translations[lang]['hide_patterns'] }}`;
                } else {
                    chartSection.style.display = 'none';
                    showPatternsBtn.innerHTML = `<i class="fas fa-chart-line"></i> {{ translations[lang]['show_patterns'] }}`;
                }
            });
        }
        
        // Setup FAQ accordion
        function setupFaqAccordion() {
            const toggleFaqBtn = document.getElementById('toggle-faq');
            const faqSection = document.getElementById('faq-section');
            
            toggleFaqBtn.addEventListener('click', function() {
                if (faqSection.style.display === 'none') {
                    faqSection.style.display = 'block';
                    toggleFaqBtn.innerHTML = `<i class="fas fa-question-circle"></i> {{ translations[lang]['hide_faq'] }}`;
                } else {
                    faqSection.style.display = 'none';
                    toggleFaqBtn.innerHTML = `<i class="fas fa-question-circle"></i> {{ translations[lang]['show_faq'] }}`;
                }
            });
            
            // FAQ item click handlers
            document.querySelectorAll('.faq-question').forEach(item => {
                item.addEventListener('click', event => {
                    const answer = item.nextElementSibling;
                    const icon = item.querySelector('i');
                    
                    if (answer.style.maxHeight) {
                        answer.style.maxHeight = null;
                        icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
                    } else {
                        answer.style.maxHeight = answer.scrollHeight + "px";
                        icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
                    }
                });
            });
        }
        
        // Setup sorting functionality
        function setupSorting() {
            const sortByWaitBtn = document.getElementById('sort-by-wait');
            const sortByTotalBtn = document.getElementById('sort-by-total');
            
            sortByWaitBtn.addEventListener('click', function() {
                sortLocations('wait');
                sortByWaitBtn.classList.add('active');
                sortByTotalBtn.classList.remove('active');
            });
            
            sortByTotalBtn.addEventListener('click', function() {
                sortLocations('total');
                sortByTotalBtn.classList.add('active');
                sortByWaitBtn.classList.remove('active');
            });
        }
        
        // Location sorting function
        function sortLocations(sortBy) {
            const container = document.getElementById('all-locations-container');
            const cards = Array.from(container.children);
            
            if (sortBy === 'wait') {
                cards.sort((a, b) => {
                    return parseInt(a.dataset.wait) - parseInt(b.dataset.wait);
                });
            } else if (sortBy === 'total') {
                cards.sort((a, b) => {
                    const aTotal = parseInt(a.querySelector('.total-time-value')?.textContent || a.dataset.wait);
                    const bTotal = parseInt(b.querySelector('.total-time-value')?.textContent || b.dataset.wait);
                    return aTotal - bTotal;
                });
            }
            
            // Reappend in sorted order
            cards.forEach(card => container.appendChild(card));
        }
        
        // Charts initialization - Auto-select current day
        function initCharts() {
            // Current day of week (0=Sunday, 1=Monday, ..., 6=Saturday)
            const currentDate = new Date();
            let currentDay = currentDate.getDay();
            
            // Default to Monday if it's a weekend
            if (currentDay === 0 || currentDay === 6) {
                currentDay = 1;
            }
            
            // Day names for display
            const dayNames = [
                "{{ translations[lang]['day_sunday'] }}",
                "{{ translations[lang]['day_monday'] }}",
                "{{ translations[lang]['day_tuesday'] }}",
                "{{ translations[lang]['day_wednesday'] }}",
                "{{ translations[lang]['day_thursday'] }}",
                "{{ translations[lang]['day_friday'] }}",
                "{{ translations[lang]['day_saturday'] }}"
            ];
            
            // Auto-select current day
            const dayButtons = document.querySelectorAll('.day-button');
            dayButtons.forEach(button => {
                if (parseInt(button.dataset.day) === currentDay) {
                    button.classList.add('active');
                }
                
                button.addEventListener('click', function() {
                    dayButtons.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    loadChartData(parseInt(this.dataset.day));
                });
            });
            
            // Pre-load data for current day
            loadChartData(currentDay);
        }
        
        // Load chart data (simplified from original)
        function loadChartData(day) {
            // Fetch chart data for selected day
            fetch(`/hourly_data?day=${day}`)
                .then(response => response.json())
                .then(data => {
                    updateOpeningHoursNote(data.opening_hours, day);
                    createOrUpdateChart(data);
                })
                .catch(error => console.error('Error loading chart data:', error));
        }
        
        // Chart creation and update functions
        function updateOpeningHoursNote(hours, day) {
            const openingHoursNote = document.getElementById('opening-hours-note');
            const [openHour, closeHour] = hours;
            
            if (openHour === 0 && closeHour === 0) {
                // Closed (weekends)
                openingHoursNote.textContent = `${dayNames[day]}: {{ translations[lang]['closed'] }}`;
                openingHoursNote.style.color = "#E32E35";
            } else if (closeHour === 20) {
                // Extended hours (Thursday)
                openingHoursNote.textContent = `${dayNames[day]}: {{ translations[lang]['open_from'] }} ${openHour}:00 {{ translations[lang]['until'] }} ${closeHour}:00 ({{ translations[lang]['extended_hours'] }})`;
                openingHoursNote.style.color = "#666";
            } else {
                // Normal hours
                openingHoursNote.textContent = `${dayNames[day]}: {{ translations[lang]['open_from'] }} ${openHour}:00 {{ translations[lang]['until'] }} ${closeHour}:00`;
                openingHoursNote.style.color = "#666";
            }
        }
        
        function createOrUpdateChart(data) {
            const ctx = document.getElementById('seasonalityChart').getContext('2d');
            const [openHour, closeHour] = data.opening_hours;
            
            // Style datasets
            data.datasets.forEach((dataset, index) => {
                const hue = (index * 137) % 360;
                dataset.borderColor = `hsl(${hue}, 70%, 45%)`;
                dataset.backgroundColor = `hsl(${hue}, 70%, 85%, 0.2)`;
                dataset.tension = 0.3;
                
                // Point styling
                const originalLength = data.labels.length;
                dataset.pointStyle = new Array(originalLength).fill('circle');
                dataset.pointRadius = new Array(originalLength).fill(3);
                dataset.pointHoverRadius = new Array(originalLength).fill(5);
                
                // Hide zero points
                for (let i = 0; i < dataset.data.length; i++) {
                    if (dataset.data[i] === 0) {
                        dataset.pointRadius[i] = 0;
                        dataset.pointHoverRadius[i] = 0;
                    }
                }
                
                // Pad truncated datasets for Chart.js
                if (dataset.hasOwnProperty('cutoffIndex')) {
                    const paddingLength = originalLength - dataset.data.length;
                    dataset.data = [
                        ...dataset.data,
                        ...Array(paddingLength).fill(null)
                    ];
                    delete dataset.cutoffIndex;
                }
            });
            
            // Destroy previous chart if exists
            if (waitTimeChart) {
                waitTimeChart.destroy();
            }
            
            // Calculate axis limits
            const minHour = 8;
            let maxHour = closeHour;
            if (maxHour < 17) maxHour = 17;
            if (maxHour > 21) maxHour = 21;
            
            // Filter labels to show relevant range
            const visibleLabels = data.labels.slice(0, maxHour - minHour + 1);
            
            // Create chart
            waitTimeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: visibleLabels,
                    datasets: data.datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    if (context.raw === 0 || context.raw === null) {
                                        return null;
                                    }
                                    return context.dataset.label + ': ' + context.raw + ' min';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            suggestedMax: 70,
                            title: {
                                display: true,
                                text: '{{ translations[lang]["average_wait_time"] }}'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '{{ translations[lang]["time_of_day"] }}'
                            },
                            min: 0,
                            max: visibleLabels.length - 1
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }
        
        // Location sharing and travel time
        function initLocationSharing() {
            // Store user location
            let userLocation = null;
            let map = null;
            
            // DOM elements
            const shareLocationBtn = document.getElementById('share-location');
            const locationStatus = document.getElementById('location-status');
            const mapContainer = document.getElementById('map-container');
            const combinedRecommendation = document.getElementById('combined-recommendation');
            const sortByTotalBtn = document.getElementById('sort-by-total');
            
            // Check if geolocation is supported
            if (!navigator.geolocation) {
                shareLocationBtn.disabled = true;
                locationStatus.textContent = "{{ translations[lang]['location_error'] }}";
                locationStatus.style.display = 'block';
                return;
            }
            
            // Handle location sharing button click
            shareLocationBtn.addEventListener('click', () => {
                shareLocationBtn.disabled = true;
                shareLocationBtn.innerHTML = `<div class="loader"></div> {{ translations[lang]['calculating'] }}`;
                
                navigator.geolocation.getCurrentPosition(
                    position => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lon: position.coords.longitude
                        };
                        
                        // Update UI
                        shareLocationBtn.innerHTML = `<i class="fas fa-check"></i> {{ translations[lang]['location_shared'] }}`;
                        shareLocationBtn.disabled = false;
                        
                        // Show map and fetch travel times
                        mapContainer.style.display = 'block';
                        initMap(userLocation);
                        fetchTravelTimes(userLocation);
                        
                        // Show sort by total button
                        sortByTotalBtn.style.display = 'block';
                    },
                    error => {
                        shareLocationBtn.innerHTML = `<i class="fas fa-bicycle"></i> {{ translations[lang]['calculate_travel'] }}`;
                        shareLocationBtn.disabled = false;
                        locationStatus.textContent = "{{ translations[lang]['location_error'] }}: " + error.message;
                        locationStatus.style.display = 'block';
                    }
                );
            });
            
            // Initialize map
            function initMap(location) {
                if (map) {
                    map.remove();
                }
                
                // Create map centered on user location
                map = L.map('map').setView([location.lat, location.lon], 11);
                
                // Add OpenStreetMap tile layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
                
                // Add user marker
                userMarker = L.marker([location.lat, location.lon], {
                    title: 'Your Location',
                    icon: L.divIcon({
                        className: 'user-marker',
                        html: '<i class="fas fa-map-marker-alt" style="color: #3498db; font-size: 24px;"></i>',
                        iconSize: [24, 24],
                        iconAnchor: [12, 24]
                    })
                }).addTo(map);
                
                // Add office markers - we'll fetch these from the API
                fetch('/api/offices')
                    .then(response => response.json())
                    .then(offices => {
                        for (const [id, office] of Object.entries(offices)) {
                            const marker = L.marker([office.lat, office.lon], {
                                title: document.querySelector(`.location-card[data-id="${id}"] h3`)?.textContent || `Office ${id}`,
                                icon: L.divIcon({
                                    className: 'office-marker',
                                    html: '<i class="fas fa-building" style="color: #E32E35; font-size: 20px;"></i>',
                                    iconSize: [20, 20],
                                    iconAnchor: [10, 20]
                                })
                            }).addTo(map);
                            
                            marker.bindPopup(`<b>${office.address}</b>`);
                            officeMarkers.push(marker);
                        }
                        
                        // Fit bounds to include all markers
                        const bounds = L.featureGroup([userMarker, ...officeMarkers]).getBounds();
                        map.fitBounds(bounds, { padding: [50, 50] });
                    })
                    .catch(error => {
                        console.error('Error fetching office locations:', error);
                    });
            }
            
            // Fetch travel times
            function fetchTravelTimes(location) {
                fetch(`/api/combined-times?lat=${location.lat}&lon=${location.lon}`)
                    .then(response => response.json())
                    .then(data => updateUIWithTravelTimes(data))
                    .catch(error => {
                        console.error('Error fetching travel times:', error);
                        locationStatus.textContent = 'Error fetching travel times. Please try again.';
                        locationStatus.style.display = 'block';
                    });
            }
            
            // Update UI with travel times
            function updateUIWithTravelTimes(combinedData) {
                // Show best combined recommendation
                if (combinedData.length > 0) {
                    const bestCombined = combinedData[0];
                    
                    // Create and display recommendation card with total time
                    const recommendationCard = document.createElement('div');
                    recommendationCard.className = 'bento';
                    recommendationCard.innerHTML = `
                        <div class="best-combined">
                            <h2><i class="fas fa-star"></i> {{ translations[lang]['best_combined'] }}</h2>
                            <p><i class="fas fa-building"></i> ${bestCombined.loket_name}</p>
                            <p><i class="fas fa-clock"></i> {{ translations[lang]['card_current_wait'] }}: ${bestCombined.wait_time} {{ translations[lang]['minutes'] }}</p>
                            <p><i class="fas fa-bicycle"></i> {{ translations[lang]['travel_time'] }}: ${bestCombined.travel_time} {{ translations[lang]['minutes'] }}</p>
                            <p><i class="fas fa-road"></i> {{ translations[lang]['distance'] }}: ${bestCombined.distance_km} {{ translations[lang]['km'] }}</p>
                            <p><i class="fas fa-hourglass-half"></i> {{ translations[lang]['total_time'] }}: ${bestCombined.total_time} {{ translations[lang]['minutes'] }}</p>
                        </div>
                    `;
                    
                    combinedRecommendation.appendChild(recommendationCard);
                }
                
                // Update all location cards with travel times
                const locationCards = document.querySelectorAll('.location-card');
                
                combinedData.forEach(data => {
                    locationCards.forEach(card => {
                        if (card.dataset.id == data.stadsloket_id) {
                            // Add travel time info
                            const travelInfo = card.querySelector('.travel-info');
                            const travelTimeValue = card.querySelector('.travel-time-value');
                            const distanceValue = card.querySelector('.distance-value');
                            
                            travelTimeValue.textContent = `{{ translations[lang]['travel_time'] }}: ${data.travel_time} {{ translations[lang]['minutes'] }}`;
                            distanceValue.textContent = `{{ translations[lang]['distance'] }}: ${data.distance_km} {{ translations[lang]['km'] }}`;
                            travelInfo.style.display = 'block';
                            
                            // Add total time
                            const combinedTime = card.querySelector('.total-time');
                            const totalTimeValue = card.querySelector('.total-time-value');
                            
                            totalTimeValue.textContent = `{{ translations[lang]['total_time'] }}: ${data.total_time} {{ translations[lang]['minutes'] }}`;
                            combinedTime.style.display = 'block';
                            
                            // Highlight the best combined card
                            if (combinedData[0] && data.stadsloket_id === combinedData[0].stadsloket_id) {
                                card.classList.add('best-combined');
                            }
                        }
                    });
                });
                
                // Sort by wait time first to maintain consistency
                sortLocations('wait');
            }
        }
        
        // Cookie consent management
        document.addEventListener('DOMContentLoaded', function() {
            const cookieBanner = document.getElementById('cookie-consent');
            const acceptAllBtn = document.getElementById('cookie-accept-all');
            const showMoreOptionsBtn = document.getElementById('show-more-options');
            const consentInitialButtons = document.getElementById('consent-initial-buttons');
            const consentAdvanced = document.getElementById('consent-advanced');
            const customizeBtn = document.getElementById('cookie-customize');
            const rejectAllBtn = document.getElementById('cookie-reject-all');
            const analyticsCheckbox = document.getElementById('consent-analytics');
            const adsCheckbox = document.getElementById('consent-ads');
            
            // Show more options when clicking "More Options" button
            showMoreOptionsBtn.addEventListener('click', function() {
                consentInitialButtons.style.display = 'none';
                consentAdvanced.style.display = 'block';
            });
            
            // Check for existing consent
            function checkConsent() {
                const consentCookie = document.cookie.split(';').find(c => c.trim().startsWith('consent_settings='));
                
                if (consentCookie) {
                    try {
                        const consentSettings = JSON.parse(decodeURIComponent(consentCookie.split('=')[1]));
                        cookieBanner.style.display = 'none';
                        updateConsentState(consentSettings);
                        return true;
                    } catch (e) {
                        console.error('Error parsing consent cookie:', e);
                    }
                }
                return false;
            }
            
            // Update Google Consent Mode based on user choices
            function updateConsentState(settings) {
                gtag('consent', 'update', {
                    'analytics_storage': settings.analytics ? 'granted' : 'denied',
                    'ad_storage': settings.ads ? 'granted' : 'denied',
                });
            }
            
            // Save consent choices
            function saveConsent(settings) {
                document.cookie = 'consent_settings=' + encodeURIComponent(JSON.stringify(settings)) + 
                    '; max-age=' + (86400 * 365) + '; path=/; SameSite=Lax';
                
                updateConsentState(settings);
                cookieBanner.style.display = 'none';
            }
            
            // Check if consent was already given
            if (!checkConsent()) {
                cookieBanner.style.display = 'block';
            }
            
            // Event handlers
            acceptAllBtn.addEventListener('click', function() {
                saveConsent({
                    analytics: true,
                    ads: true
                });
            });
            
            rejectAllBtn.addEventListener('click', function() {
                saveConsent({
                    analytics: false,
                    ads: false
                });
            });
            
            customizeBtn.addEventListener('click', function() {
                saveConsent({
                    analytics: analyticsCheckbox.checked,
                    ads: adsCheckbox.checked
                });
            });
        });
    </script>

    <!-- Footer - simplified -->
    <footer class="footer">
        <p>© 2025 <a href="https://www.twankerkhof.nl" target="_blank">Twan Kerkhof</a></p>
        <nav class="footer-nav">
            <a href="{{ url_for('index') }}">{{ translations[lang]['nav_home'] }}</a>
            <a href="{{ url_for('privacy') }}">{{ translations[lang]['nav_privacy'] }}</a>
        </nav>
    </footer>
</body>
</html>

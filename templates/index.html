<!DOCTYPE html>
<html lang="{{ lang|default('nl') }}">
    <head>
        <!-- Google Tag Manager -->
        <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() {dataLayer.push(arguments);}
        
        // Default consent settings - all denied until user gives consent
        gtag('consent', 'default', {
            'ad_storage': 'denied',
            'analytics_storage': 'denied',
            'wait_for_update': 500
        });
        </script>
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-4XECBEDSBR"></script>
        <script>
          gtag('js', new Date());
          gtag('config', 'G-4XECBEDSBR');
          // AdSense configuration
          gtag('config', 'ca-pub-4863672404977337');
        </script>
        
        <!-- Google AdSense -->
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4863672404977337" crossorigin="anonymous"></script>

        <!-- AdSense initialization -->
        <script>
        window.addEventListener('load', function() {
            // AdSense auto-initialization is preferred over manual initialization
            console.log('Page loaded - AdSense ready');
        });
        </script>
        
        <!-- Primary Meta Tags -->
        <meta charset="UTF-8">
        <title>{{ translations[lang]['site_title'] }}</title>
        <meta name="description" content="{{ translations[lang]['site_description'] }}">
        <meta name="keywords" content="{{ translations[lang]['site_keywords'] }}">
        <meta name="author" content="Twan Kerkhof">
        
        <!-- Canonical URL and Language alternates -->
        <link rel="canonical" href="{{ request.url_root }}" />
        <link rel="alternate" hreflang="nl" href="{{ request.url_root }}?lang=nl" />
        <link rel="alternate" hreflang="en" href="{{ request.url_root }}?lang=en" />
        <link rel="alternate" hreflang="tr" href="{{ request.url_root }}?lang=tr" />
        <link rel="alternate" hreflang="ma" href="{{ request.url_root }}?lang=ma" />
        <link rel="alternate" hreflang="x-default" href="{{ request.url_root }}" />
        
        <!-- Viewport and Favicon -->
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="icon" href="{{ url_for('static', filename='images/favicon.ico') }}" type="image/x-icon">
        <link rel="shortcut icon" href="{{ url_for('static', filename='images/favicon.ico') }}" type="image/x-icon">
        <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='images/apple-touch-icon.png') }}">
        <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='images/favicon-32x32.png') }}">
        <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='images/favicon-16x16.png') }}">
        <link rel="manifest" href="{{ url_for('static', filename='site.webmanifest') }}">
        <meta name="theme-color" content="#E32E35">
        
        <!-- Open Graph / Facebook -->
        <meta property="og:type" content="website">
        <meta property="og:url" content="{{ request.url }}">
        <meta property="og:title" content="{{ translations[lang]['og_title'] }}">
        <meta property="og:description" content="{{ translations[lang]['og_description'] }}">
        <meta property="og:image" content="{{ url_for('static', filename='images/hero_design_remove_bg_cropped.png', _external=True) }}">
        
        <!-- Twitter -->
        <meta property="twitter:card" content="summary_large_image">
        <meta property="twitter:url" content="{{ request.url }}">
        <meta property="twitter:title" content="{{ translations[lang]['og_title'] }}">
        <meta property="twitter:description" content="{{ translations[lang]['og_description'] }}">
        <meta property="twitter:image" content="{{ url_for('static', filename='images/hero_design_remove_bg_cropped.png', _external=True) }}">
        
        <!-- Structured Data -->
        <script type="application/ld+json">
        {
          "@context": "https://schema.org",
          "@type": "WebApplication",
          "name": "{{ translations[lang]['app_name'] }}",
          "description": "{{ translations[lang]['app_description'] }}",
          "url": "{{ request.url_root }}",
          "applicationCategory": "UtilityApplication",
          "operatingSystem": "All",
          "keywords": "{{ translations[lang]['app_keywords'] }}",
          "offers": {
            "@type": "Offer",
            "price": "0"
          },
          "provider": {
            "@type": "Person",
            "name": "Twan Kerkhof"
          },
          "audience": {
            "@type": "Audience",
            "audienceType": "{{ translations[lang]['app_audience'] }}"
          }
        }
        </script>
        
        <!-- Resource preconnection -->
        <link rel="preconnect" href="https://cdnjs.cloudflare.com">
        <link rel="preconnect" href="https://cdn.jsdelivr.net">
        
        <!-- Stylesheets -->
        <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
        
        <!-- External libraries -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js" defer></script>
        
        <!-- Cache control -->
        <meta http-equiv="Cache-Control" content="max-age=1800">

        <!-- No local TCF stub: Google CMP will define __tcfapi itself -->
        <style>
    .intro-container {
        text-align: center;
        margin: 40px auto; /* Increased vertical margin for more space */
        padding: 0 15px;
        max-width: 90%; /* Responsive width for mobile */
    }
    .intro-container p {
        font-size: 1.25rem; /* Larger, subtitle-like font size */
        line-height: 1.7;
        color: #555; /* Softer text color */
        margin: 0;
    }
    @media (min-width: 768px) {
        .intro-container {
            max-width: 650px; /* Narrower width on desktop */
        }
    }
</style>
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
              integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
              crossorigin=""/>
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
              integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
              crossorigin=""></script>
    </head>
<body>
    <!-- Language switcher -->
    <div class="language-switcher">
        {% for code, label, flag in supported_languages %}
            <a href="?lang={{ code }}">
                {{ flag }}
            </a>
        {% endfor %}
    </div>

    <!-- Hero section -->
    <header class="hero">
        <div class="hero-content">
            <h1>{{ translations[lang]['hero_title'] }}</h1>
            <p>{{ translations[lang]['hero_subtitle'] }}</p>
        </div>
        <div class="hero-image">
            <img src="{{ url_for('static', filename='images/hero_design_remove_bg_cropped.png') }}" alt="{{ translations[lang]['hero_image_alt'] }}">
        </div>
    </header>
    
    <!-- Breadcrumb navigation -->
    <div class="breadcrumb">
        <div class="content-container">
            <span>
                <a href="{{ request.url_root }}">Home</a> »
                <span>{{ translations[lang]['breadcrumb_title'] }}</span>
            </span>
        </div>
    </div>

    <div class="intro-container content-container">
        <p>{{ translations[lang]['intro_text'] }}</p>
    </div>
    
    <div style="text-align: center; margin: 20px 0;">
        <input type="text" id="postcode-input" placeholder="{{ translations[lang]['postcode_placeholder'] }}" style="padding: 10px; border-radius: 8px; border: 1px solid #ddd; margin-right: 10px;">
        <button id="calculate-travel-time" class="loket-button" style="background-color: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-size: 1rem; cursor: pointer;">
            <i class="fas fa-bicycle"></i> 
            {{ translations[lang]['calculate_travel_time'] }}
        </button>
        <button id="share-location" class="loket-button" style="background-color: #2ecc71; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-size: 1rem; cursor: pointer;">
            <i class="fas fa-map-marker-alt"></i> 
            {{ translations[lang]['use_current_location'] }}
        </button>
        <p id="location-status" style="display: none; color: #e74c3c; margin-top: 10px;"></p>
    </div>
    <div id="map-container" style="margin: 20px auto; max-width: 1200px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); border-radius: 10px; overflow: hidden; display: none;">
        <div id="map" style="height: 300px; width: 100%;"></div>
    </div>
    <!-- Moved below map so the recommendation appears under the map -->
    <div id="combined-recommendation" style="display: none; margin: 20px auto; text-align: center;"></div>


    <!-- Recommended location section -->
    {% if best_loket %}
    <div class="bento">
        <div class="best-loket loket-card" data-loket="{{ best_loket[1] }}">
            <h2><i class="fas fa-star"></i> {{ translations[lang]['card_recommended_location'] }}</h2>
            <p><i class="fas fa-building"></i> {{ best_loket[1] }}</p>
            <p><i class="fas fa-clock"></i> {{ translations[lang]['card_current_wait'] }}: {{ best_loket[2] }} {{ translations[lang]['minutes'] }}</p>
            <p><i class="fas fa-users"></i> {{ translations[lang]['card_currently_waiting'] }}: {{ best_loket[3] }} {{ translations[lang]['people'] }}</p>
        </div>
    </div>
    {% endif %}

    <!-- Advertisement section 1 -->
    <div class="ad-container">
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4863672404977337"
             crossorigin="anonymous"></script>
        <!-- Horizontal -->
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-4863672404977337"
             data-ad-slot="4370543747"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
        <script>
             (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
    </div>

    <!-- Location data grid -->
    <div class="bento">
        {% for loket in loket_data %}
        <div class="loket-card" data-loket="{{ loket[1] }}" data-id="{{ loket[0] }}">
            <h3><i class="fas fa-building"></i> {{ loket[1] }}</h3>
            <p><i class="fas fa-clock"></i> {{ translations[lang]['card_current_wait'] }}: {{ loket[2] }} {{ translations[lang]['minutes'] }}</p>
            <p><i class="fas fa-users"></i> {{ translations[lang]['card_currently_waiting'] }}: {{ loket[3] }} {{ translations[lang]['people'] }}</p>
            <div class="travel-info" style="display: none; margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px;">
                <p class="travel-time"><i class="fas fa-bicycle"></i> {{ translations[lang]['travel_time'] }}: <span class="travel-time-value"></span></p>
                <p class="distance"><i class="fas fa-road"></i> {{ translations[lang]['distance'] }}: <span class="distance-value"></span></p>
                <p class="total-time" style="font-weight: bold;"><i class="fas fa-hourglass-half"></i> {{ translations[lang]['total_time'] }}: <span class="total-time-value"></span></p>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- Seasonality chart section -->
    <div id="wait-patterns" class="chart-container">
        <h2>{{ translations[lang]['plot_title'] }}</h2>
        <p>{{ translations[lang]['plot_subtitle'] }}</p>
        
        <div class="day-selector">
            <button class="day-button" data-day="1">{{ translations[lang]['day_monday'] }}</button>
            <button class="day-button" data-day="2">{{ translations[lang]['day_tuesday'] }}</button>
            <button class="day-button" data-day="3">{{ translations[lang]['day_wednesday'] }}</button>
            <button class="day-button" data-day="4">{{ translations[lang]['day_thursday'] }}</button>
            <button class="day-button" data-day="5">{{ translations[lang]['day_friday'] }}</button>
        </div>

        <!-- Loket selector -->
        <div class="loket-selector">
            <button class="loket-button active" data-loket="all">{{ translations[lang]['all_locations'] }}</button>
            {% for loket in loket_data %}
            <button class="loket-button" data-loket="{{ loket[1] }}">{{ loket[1] }}</button>
            {% endfor %}
        </div>
        
        <div class="opening-hours-note" id="opening-hours-note"></div>
        
        <div class="chart-responsive-wrapper">
            <canvas id="seasonalityChart"></canvas>
        </div>
    </div>

    <!-- Advertisement section 2 -->
    <div class="ad-container">
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4863672404977337"
             crossorigin="anonymous"></script>
        <!-- Horizontal -->
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-4863672404977337"
             data-ad-slot="4370543747"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
        <script>
             (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
    </div>
    
    <!-- FAQ section -->
    <section class="faq-section">
        <h2>{{ translations[lang]['faq_title'] }}</h2>
        
        <div class="faq-items">
            <div class="faq-item">
                <h3><i class="fas fa-question-circle"></i> {{ translations[lang]['faq_q1_title'] }}</h3>
                <p>{{ translations[lang]['faq_q1_text'] }}</p>
            </div>
            
            <div class="faq-item">
                <h3><i class="fas fa-map-marker-alt"></i> {{ translations[lang]['faq_q2_title'] }}</h3>
                <p>{{ translations[lang]['faq_q2_text'] }}</p>
            </div>
            
            <div class="faq-item">
                <h3><i class="fas fa-clock"></i> {{ translations[lang]['faq_q3_title'] }}</h3>
                <p>{{ translations[lang]['faq_q3_text'] }}</p>
            </div>
            
            <div class="faq-item">
                <h3><i class="fas fa-calendar-check"></i> {{ translations[lang]['faq_q4_title'] }}</h3>
                <p>{{ translations[lang]['faq_q4_text'] }}</p>
            </div>
            
            <div class="faq-item">
                <h3><i class="fas fa-door-open"></i> {{ translations[lang]['faq_q5_title'] }}</h3>
                <p>{{ translations[lang]['faq_q5_text'] }}</p>
            </div>
        </div>
    </section>
    
    <!-- App JavaScript -->
    <script>
        // Chart instance variable
        let waitTimeChart = null;
        let activeLoketFilter = 'all'; // Central state for the current filter

        // Current day of week (0=Sunday, 1=Monday, ..., 6=Saturday)
        const currentDate = new Date();
        let currentDay = currentDate.getDay();
        
        // Default to Monday if it's a weekend
        if (currentDay === 0 || currentDay === 6) {
            currentDay = 1;
        }
        
        // Day names for display
        const dayNames = [
            "{{ translations[lang]['day_sunday'] }}",
            "{{ translations[lang]['day_monday'] }}",
            "{{ translations[lang]['day_tuesday'] }}",
            "{{ translations[lang]['day_wednesday'] }}",
            "{{ translations[lang]['day_thursday'] }}",
            "{{ translations[lang]['day_friday'] }}",
            "{{ translations[lang]['day_saturday'] }}"
        ];
        
        /**
         * Central function to update chart and UI based on a filter.
         * @param {string} targetLoket - The name of the loket to show, or 'all'.
         * @param {object} options - Additional options, e.g., { scroll: true }
         */
        function setLoketFilter(targetLoket, options = {}) {
            activeLoketFilter = targetLoket;

            // Update button active states
            document.querySelectorAll('.loket-button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.loket === targetLoket);
            });

            // Update chart dataset visibility
            if (waitTimeChart) {
                waitTimeChart.data.datasets.forEach(ds => {
                    ds.hidden = (targetLoket !== 'all' && ds.label !== targetLoket);
                });
                waitTimeChart.update();
            }

            // Scroll to chart if requested
            if (options.scroll) {
                const chartSection = document.getElementById('wait-patterns');
                if (chartSection) {
                    chartSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
        }

        /**
         * Initialize day selector and load initial chart data
         */
        document.addEventListener('DOMContentLoaded', function() {
            // Cards, day buttons, and loket buttons are set up here.
            
            // Attach unified click handler to location cards
            document.querySelectorAll('.loket-card').forEach(card => {
                card.style.cursor = 'pointer';
                card.addEventListener('click', function() {
                    setLoketFilter(this.dataset.loket, { scroll: true });
                });
            });
            
            // Attach unified click handler to loket filter buttons
            document.querySelectorAll('.loket-button').forEach(btn => {
                btn.addEventListener('click', function() {
                    setLoketFilter(this.dataset.loket);
                });
            });

            const dayButtons = document.querySelectorAll('.day-button');
            
            // Set initial active button
            dayButtons.forEach(button => {
                if (parseInt(button.dataset.day) === currentDay) {
                    button.classList.add('active');
                }
                
                // Add click event handler
                button.addEventListener('click', function() {
                    dayButtons.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    loadChartData(parseInt(this.dataset.day));
                });
            });
            
            // Load initial chart data
            loadChartData(currentDay);
            initLocationSharing();
        });
        
        /**
         * Load chart data for a specific day
         * @param {number} day - Day of week (0-6)
         */
        function loadChartData(day) {
            fetch(`/hourly_data?day=${day}`)
                .then(response => response.json())
                .then(data => {
                    updateOpeningHoursNote(data.opening_hours, day);
                    applyOpeningHoursFilter(data);
                    createOrUpdateChart(data);
                })
                .catch(error => console.error('Error loading chart data:', error));
        }
        
        /**
         * Update opening hours message
         * @param {Array} hours - Opening and closing hours
         * @param {number} day - Day of week
         */
        function updateOpeningHoursNote(hours, day) {
            const openingHoursNote = document.getElementById('opening-hours-note');
            const [openHour, closeHour] = hours;
            
            if (openHour === 0 && closeHour === 0) {
                // Closed (weekends)
                openingHoursNote.textContent = `${dayNames[day]}: {{ translations[lang]['closed'] }}`;
                openingHoursNote.style.color = "#E32E35";
            } else if (closeHour === 20) {
                // Extended hours (Thursday)
                openingHoursNote.textContent = `${dayNames[day]}: {{ translations[lang]['open_from'] }} ${openHour}:00 {{ translations[lang]['until'] }} ${closeHour}:00 ({{ translations[lang]['extended_hours'] }})`;
                openingHoursNote.style.color = "#666";
            } else {
                // Normal hours
                openingHoursNote.textContent = `${dayNames[day]}: {{ translations[lang]['open_from'] }} ${openHour}:00 {{ translations[lang]['until'] }} ${closeHour}:00`;
                openingHoursNote.style.color = "#666";
            }
        }
        
        /**
         * Apply zero values outside opening hours and truncate datasets
         * @param {Object} data - Chart data object
         * @return {Object} Modified data object
         */
        function applyOpeningHoursFilter(data) {
            const [openHour, closeHour] = data.opening_hours;
            
            data.datasets.forEach(dataset => {
                // Mark values outside opening hours as zero
                for (let i = 0; i < dataset.data.length; i++) {
                    const hour = i + 8; // Data starts at 8:00
                    if (hour < openHour || hour >= closeHour) {
                        dataset.data[i] = 0;
                    }
                }
                
                // Find and truncate after two consecutive zeros
                let cutoffIndex = -1;
                for (let i = 0; i < dataset.data.length - 1; i++) {
                    if (dataset.data[i] === 0 && dataset.data[i + 1] === 0) {
                        cutoffIndex = i;
                        break;
                    }
                }
                
                // Truncate if needed
                if (cutoffIndex !== -1) {
                    dataset.data = dataset.data.slice(0, cutoffIndex + 1);
                    dataset.cutoffIndex = cutoffIndex;
                }
            });
            
            return data;
        }
        
        /**
         * Create or update the wait time chart
         * @param {Object} data - Chart data object
         */
        function createOrUpdateChart(data) {
            const ctx = document.getElementById('seasonalityChart').getContext('2d');
            const [openHour, closeHour] = data.opening_hours;
            
            // Style datasets
            data.datasets.forEach((dataset, index) => {
                const hue = (index * 137) % 360;
                dataset.borderColor = `hsl(${hue}, 70%, 45%)`;
                dataset.backgroundColor = `hsl(${hue}, 70%, 85%, 0.2)`;
                dataset.tension = 0.3;
                
                // Point styling
                const originalLength = data.labels.length;
                dataset.pointStyle = new Array(originalLength).fill('circle');
                dataset.pointRadius = new Array(originalLength).fill(3);
                dataset.pointHoverRadius = new Array(originalLength).fill(5);
                
                // Hide zero points
                for (let i = 0; i < dataset.data.length; i++) {
                    if (dataset.data[i] === 0) {
                        dataset.pointRadius[i] = 0;
                        dataset.pointHoverRadius[i] = 0;
                    }
                }
                
                // Pad truncated datasets for Chart.js
                if (dataset.hasOwnProperty('cutoffIndex')) {
                    const paddingLength = originalLength - dataset.data.length;
                    dataset.data = [
                        ...dataset.data,
                        ...Array(paddingLength).fill(null)
                    ];
                    delete dataset.cutoffIndex;
                }
            });
            
            // Destroy previous chart if exists
            if (waitTimeChart) {
                waitTimeChart.destroy();
            }
            
            // Calculate axis limits
            const minHour = 8;
            let maxHour = closeHour;
            if (maxHour < 17) maxHour = 17;
            if (maxHour > 21) maxHour = 21;
            
            // Filter labels to show relevant range
            const visibleLabels = data.labels.slice(0, maxHour - minHour + 1);
            
            // Create chart
            waitTimeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: visibleLabels,
                    datasets: data.datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            onClick: (e, legendItem, legend) => {
                                // When a legend item is clicked, use our central filter function
                                const clickedLoket = legendItem.text;
                                // If the clicked item is already the active filter, show all. Otherwise, activate it.
                                const newFilter = (activeLoketFilter === clickedLoket) ? 'all' : clickedLoket;
                                setLoketFilter(newFilter);
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    if (context.raw === 0 || context.raw === null) {
                                        return null;
                                    }
                                    return context.dataset.label + ': ' + context.raw + ' min';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            suggestedMax: 70,
                            title: {
                                display: true,
                                text: '{{ translations[lang]["average_wait_time"] }}'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '{{ translations[lang]["time_of_day"] }}'
                            },
                            min: 0,
                            max: visibleLabels.length - 1
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });

            // Re-apply the active filter whenever the chart is redrawn (e.g., changing day)
            setLoketFilter(activeLoketFilter);
        }

        function initLocationSharing() {
            const shareLocationBtn = document.getElementById('share-location');
            const calculateTravelTimeBtn = document.getElementById('calculate-travel-time');
            const postcodeInp = document.getElementById('postcode-input');
            const locationStatus = document.getElementById('location-status');
            const mapContainer = document.getElementById('map-container');
            const combinedRecommendation = document.getElementById('combined-recommendation');
            let map = null;
            let userMarker = null;
            let officeMarkersGroup = L.layerGroup();
            let routeLine = null;

            // Make the dynamically added "Best Choice" card clickable
            combinedRecommendation.addEventListener('click', (event) => {
                const card = event.target.closest('.loket-card');
                if (card && card.dataset.loket) {
                    setLoketFilter(card.dataset.loket, { scroll: true });
                }
            });

            // Trigger calculation on Enter key press
            postcodeInp.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault(); // Prevent form submission
                    calculateTravelTimeBtn.click();
                }
            });

            // Auto-format postcode input as the user types
            postcodeInp.addEventListener('input', () => {
                // Clear any previous error states
                locationStatus.style.display = 'none';
                postcodeInp.style.borderColor = '#ddd';
                
                let value = postcodeInp.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
                if (value.length > 4) {
                    value = value.slice(0, 4) + ' ' + value.slice(4);
                }
                postcodeInp.value = value.slice(0, 7);
            });

            calculateTravelTimeBtn.addEventListener('click', () => {
                const postcode = postcodeInp.value;
                const postcodeRegex = /^[1-9][0-9]{3}\s?[A-Z]{2}$/i;

                if (!postcode) {
                    locationStatus.textContent = "{{ translations[lang]['enter_postcode'] }}";
                    locationStatus.style.display = 'block';
                    postcodeInp.style.borderColor = 'red';
                    return;
                }

                if (!postcodeRegex.test(postcode)) {
                    locationStatus.textContent = "{{ translations[lang]['invalid_postcode'] }}";
                    locationStatus.style.display = 'block';
                    postcodeInp.style.borderColor = 'red';
                    return;
                }
                
                fetchTravelTimes(null, postcode);
            });

            if (!navigator.geolocation) {
                shareLocationBtn.disabled = true;
                shareLocationBtn.title = "{{ translations[lang]['geolocation_unavailable'] }}";
            }

            shareLocationBtn.addEventListener('click', () => {
                fetchTravelTimes({ useGeolocation: true }, null);
            });

            function initMap(location) {
                if (!map) {
                    // First time setup: create map and add office markers
                    map = L.map('map').setView([location.lat, location.lon], 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(map);

                    officeMarkersGroup.addTo(map);

                    // Fetch and add office markers only once
                    fetch('/api/offices')
                        .then(response => response.json())
                        .then(offices => {
                            for (const [id, office] of Object.entries(offices)) {
                                const officeName = document.querySelector(`.loket-card[data-id="${id}"] h3`)?.textContent || `${translations[lang]['stadsloket_prefix']} ${id}`;
                                const officeMarker = L.marker([office.lat, office.lon])
                                    .bindPopup(officeName);
                                officeMarkersGroup.addLayer(officeMarker);
                            }
                        });
                }

                // Update user marker on every call
                if (userMarker) {
                    userMarker.setLatLng([location.lat, location.lon]);
                } else {
                    userMarker = L.marker([location.lat, location.lon])
                        .bindPopup('Jouw locatie')
                        .addTo(map);
                }
                
                // Center map on the new location and open the popup
                map.setView([location.lat, location.lon], 13);
                userMarker.openPopup();
            }

            function fetchTravelTimes(location, postcode) {
                // Smoothly scroll so the postcode & location controls are near the top of the viewport
                const controlsContainer = postcodeInp.parentElement;
                if (controlsContainer) {
                    const yOffset = controlsContainer.getBoundingClientRect().top + window.pageYOffset - 20; // 20px padding
                    window.scrollTo({ top: yOffset, behavior: 'smooth' });
                }
                let url = '/api/combined-times?';
                const buttonToUpdate = postcode ? calculateTravelTimeBtn : shareLocationBtn;
                const originalButtonText = buttonToUpdate.innerHTML;

                // Clear previous errors and reset styles
                locationStatus.style.display = 'none';
                postcodeInp.style.borderColor = '#ddd';
                buttonToUpdate.disabled = true;
                buttonToUpdate.innerHTML = `<span>{{ translations[lang]['calculating'] }}</span>`;

                if (location && location.useGeolocation) {
                    navigator.geolocation.getCurrentPosition(
                        position => {
                            const userLocation = {
                                lat: position.coords.latitude,
                                lon: position.coords.longitude
                            };
                            url += `lat=${userLocation.lat}&lon=${userLocation.lon}`;
                            
                            mapContainer.style.display = 'block';
                            initMap(userLocation);
                            
                            performFetch(url, buttonToUpdate, originalButtonText);
                        },
                        error => {
                            locationStatus.textContent = "{{ translations[lang]['location_error'] }} " + error.message;
                            locationStatus.style.display = 'block';
                            buttonToUpdate.disabled = false;
                            buttonToUpdate.innerHTML = originalButtonText;
                        }
                    );
                } else if (postcode) {
                    url += `postcode=${postcode}`;
                    performFetch(url, buttonToUpdate, originalButtonText);
                } else {
                     buttonToUpdate.disabled = false;
                     buttonToUpdate.innerHTML = originalButtonText;
                    return;
                }
            }
            
            function performFetch(url, button, originalText) {
                button.disabled = true;
                button.innerHTML = `<span>{{ translations[lang]['calculating'] }}</span>`;

                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(err => { throw new Error(err.error || 'Server error'); });
                        }
                        return response.json();
                    })
                    .then(data => {
                        button.disabled = false;
                        button.innerHTML = originalText;
                        
                        if (data.length === 0) {
                            locationStatus.textContent = "{{ translations[lang]['travel_time_error'] }}";
                            locationStatus.style.display = 'block';
                        } else {
                            const userLocation = data.user_location;
                            const locations = data.locations;

                            if (userLocation) {
                                mapContainer.style.display = 'block';
                                initMap(userLocation);
                            }
                            
                            if (locations && locations.length === 0) {
                                locationStatus.textContent = "{{ translations[lang]['travel_time_error'] }}";
                                locationStatus.style.display = 'block';
                            } else {
                                updateUIWithTravelTimes(locations, userLocation);
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching travel times:', error);
                        button.disabled = false;
                        button.innerHTML = originalText;
                        locationStatus.textContent = error.message || "{{ translations[lang]['travel_time_error'] }}";
                        locationStatus.style.display = 'block';
                    });
            }

            function updateUIWithTravelTimes(combinedData, userLocation) {
                const bestCombined = combinedData[0];
                
                if (bestCombined) {
                    // Remove any previously rendered recommended card (server-side) to prevent duplicate cards
                    document.querySelectorAll('.best-loket.loket-card').forEach(card => {
                        if (!combinedRecommendation.contains(card)) {
                            const parentBento = card.closest('.bento');
                            (parentBento || card).remove();
                        }
                    });

                    const combinedCard = `
                        <div class="bento">
                            <div class="best-loket loket-card" data-loket="${bestCombined.loket_name}" style="cursor: pointer;">
                                <h2><i class="fas fa-star-half-alt"></i> {{ translations[lang]['best_choice'] }}</h2>
                                <p><i class="fas fa-building"></i> ${bestCombined.loket_name}</p>
                                <p><i class="fas fa-hourglass-half"></i> {{ translations[lang]['total_time'] }}: ${bestCombined.total_time} {{ translations[lang]['minutes'] }}</p>
                                <p><i class="fas fa-clock"></i> {{ translations[lang]['card_current_wait'] }}: ${bestCombined.wait_time} {{ translations[lang]['minutes'] }}</p>
                                <p><i class="fas fa-bicycle"></i> {{ translations[lang]['travel_time'] }}: ${bestCombined.travel_time} {{ translations[lang]['minutes'] }}</p>
                            </div>
                        </div>`;
                    combinedRecommendation.innerHTML = combinedCard;
                    combinedRecommendation.style.display = 'block';
                    
                    // Draw route for the best option
                    if (bestCombined.geometry && bestCombined.geometry.length > 0) {
                        if (routeLine) {
                            routeLine.remove();
                        }
                        routeLine = L.polyline(bestCombined.geometry, {color: 'blue'}).addTo(map);
                        
                        // Fit map to route bounds
                        map.fitBounds(routeLine.getBounds());
                    } else if(userLocation) {
                        // If no route, just show the user and the loket
                        const officeLocation = officeMarkersGroup.getLayers().find(marker => 
                            marker.getPopup().getContent().includes(bestCombined.loket_name)
                        )?.getLatLng();

                        if (officeLocation) {
                           map.fitBounds([
                                [userLocation.lat, userLocation.lon],
                                [officeLocation.lat, officeLocation.lng]
                           ]);
                        }
                    }
                }

                combinedData.forEach(item => {
                    const card = document.querySelector(`.loket-card[data-id="${item.stadsloket_id}"]`);
                    if (card) {
                        const travelInfoDiv = card.querySelector('.travel-info');
                        card.querySelector('.travel-time-value').textContent = `${item.travel_time} {{ translations[lang]['minutes'] }}`;
                        card.querySelector('.distance-value').textContent = `${item.distance_km} km`;
                        card.querySelector('.total-time-value').textContent = `${item.total_time} {{ translations[lang]['minutes'] }}`;
                        travelInfoDiv.style.display = 'block';
                    }
                });
            }
        }
    </script>

    <!-- Footer -->
    <footer class="footer">
        <p>© 2025 <a href="https://www.twankerkhof.nl" target="_blank">Twan Kerkhof</a> | {{ translations[lang]['footer_text'] }}</p>
        <p style="color: #999;">{{ translations[lang]['footer_disclaimer'] }}</p>
        <p><a href="https://www.amsterdam.nl/contact/" target="_blank">{{ translations[lang]['footer_official_link'] }}</a></p>
        <nav class="footer-nav">
            <a href="{{ url_for('index') }}">{{ translations[lang]['nav_home'] }}</a>
            <a href="{{ url_for('privacy') }}">{{ translations[lang]['nav_privacy'] }}</a>
        </nav>
    </footer>
</body>
</html>
